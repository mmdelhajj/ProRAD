import{u as e,d as l,j as a}from"./data-vendor-C6mPcuPT.js";import{r as s}from"./react-vendor-C4Xey-hE.js";import{f as r,c as t,y as i,i as n,r as c}from"./index-DRJG7jyl.js";import{u as d,f as o,a as u}from"./table-vendor-BZVOk-Gl.js";import{z as v}from"./ui-vendor-CMKyyIMz.js";import{F as m}from"./TrashIcon-BFZdbUYd.js";import{F as h}from"./PlayIcon-0-RjI_79.js";import{F as x}from"./EyeIcon-CLCqJwk9.js";import"./chart-vendor-Be69IwoK.js";function p(){var p;const[b,j]=s.useState({reseller_id:0,service_id:0,status_filter:"all",include_sub_resellers:!1}),[g,N]=s.useState(""),[f,y]=s.useState(""),[_,C]=s.useState([]),[w,S]=s.useState({field:"username",rule:"like",value:""}),[k,P]=s.useState(null),[q,F]=s.useState(0),[A,K]=s.useState(1),[E,I]=s.useState(50),{data:M}=e({queryKey:["services"],queryFn:()=>n.list().then(e=>e.data.data||[])}),{data:R}=e({queryKey:["resellers"],queryFn:()=>c.list().then(e=>e.data.data||[])}),B=l({mutationFn:e=>i.post(`/subscribers/change-bulk?page=${A}&limit=${E}`,{...e,preview:!0}),onSuccess:e=>{var l;P(e.data.data||[]),F((null==(l=e.data.meta)?void 0:l.total)||0)},onError:e=>{var l,a;return v.error((null==(a=null==(l=e.response)?void 0:l.data)?void 0:a.message)||"Failed to preview")}}),U=l({mutationFn:e=>i.post("/subscribers/change-bulk",{...e,preview:!1}),onSuccess:e=>{v.success(e.data.message||"Bulk action completed"),P(null),F(0)},onError:e=>{var l,a;return v.error((null==(a=null==(l=e.response)?void 0:l.data)?void 0:a.message)||"Failed to execute")}}),V=()=>{const e={...b,action:g,action_value:f,filters:_};B.mutate(e)},z=s.useMemo(()=>[{accessorKey:"username",header:"Username"},{accessorKey:"full_name",header:"Name"},{accessorKey:"Reseller",header:"Reseller",cell:({row:e})=>{var l,a;return(null==(a=null==(l=e.original.Reseller)?void 0:l.User)?void 0:a.username)||"-"}},{accessorKey:"address",header:"Address"},{accessorKey:"price",header:"Price",cell:({getValue:e})=>{var l;return`$${(null==(l=e())?void 0:l.toFixed(2))||"0.00"}`}},{accessorKey:"phone",header:"Phone"},{accessorKey:"Service",header:"Service",cell:({row:e})=>{var l;return(null==(l=e.original.Service)?void 0:l.name)||"-"}},{accessorKey:"created_at",header:"Created",cell:({getValue:e})=>r(e())},{accessorKey:"expiry_date",header:"Expiry",cell:({getValue:e})=>r(e())}],[]),G=d({data:k||[],columns:z,getCoreRowModel:u()}),$=[{value:"",label:"Please select action"},{value:"set_expiry",label:"Set expiry date"},{value:"set_service",label:"Set service"},{value:"set_reseller",label:"Set reseller"},{value:"set_active",label:"Set active"},{value:"set_inactive",label:"Set inactive"},{value:"set_monthly_quota",label:"Set monthly quota (GB)"},{value:"set_daily_quota",label:"Set daily quota (MB)"},{value:"set_price",label:"Set price"},{value:"reset_mac",label:"Reset MAC"}],L=[{value:"username",label:"Username"},{value:"expiry",label:"Expiry"},{value:"name",label:"Name"},{value:"address",label:"Address"},{value:"price",label:"Price"}],D=[{value:"equal",label:"Equal"},{value:"notequal",label:"Not Equal"},{value:"greater",label:"Greater"},{value:"less",label:"Less"},{value:"like",label:"Like"}];return a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Change Bulk"}),a.jsx("p",{className:"text-gray-600",children:"Perform bulk operations on subscribers based on filters"})]}),a.jsx("div",{className:"card bg-base-100 shadow",children:a.jsxs("div",{className:"card-body",children:[a.jsx("h2",{className:"card-title text-lg",children:"Filters & Action"}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[a.jsxs("div",{className:"form-control",children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"Reseller"})}),a.jsxs("select",{className:"select select-bordered",value:b.reseller_id,onChange:e=>j({...b,reseller_id:parseInt(e.target.value)}),children:[a.jsx("option",{value:0,children:"All"}),null==R?void 0:R.map(e=>{var l;return a.jsx("option",{value:e.id,children:(null==(l=e.User)?void 0:l.username)||e.company_name},e.id)})]})]}),a.jsxs("div",{className:"form-control",children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"Service"})}),a.jsxs("select",{className:"select select-bordered",value:b.service_id,onChange:e=>j({...b,service_id:parseInt(e.target.value)}),children:[a.jsx("option",{value:0,children:"All"}),null==M?void 0:M.map(e=>a.jsx("option",{value:e.id,children:e.name},e.id))]})]}),a.jsxs("div",{className:"form-control",children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"Status"})}),a.jsxs("select",{className:"select select-bordered",value:b.status_filter,onChange:e=>j({...b,status_filter:e.target.value}),children:[a.jsx("option",{value:"all",children:"All"}),a.jsx("option",{value:"active",children:"Active"}),a.jsx("option",{value:"inactive",children:"Inactive"}),a.jsx("option",{value:"active_inactive",children:"Active/Inactive"}),a.jsx("option",{value:"expired",children:"Expired"})]})]}),a.jsx("div",{className:"form-control",children:a.jsxs("label",{className:"label cursor-pointer justify-start gap-2",children:[a.jsx("input",{type:"checkbox",className:"checkbox checkbox-primary",checked:b.include_sub_resellers,onChange:e=>j({...b,include_sub_resellers:e.target.checked})}),a.jsx("span",{className:"label-text",children:"Include Sub-resellers"})]})}),a.jsxs("div",{className:"form-control",children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"Action to be done"})}),a.jsx("select",{className:"select select-bordered",value:g,onChange:e=>{N(e.target.value),y("")},children:$.map(e=>a.jsx("option",{value:e.value,children:e.label},e.value))})]}),g&&!["set_active","set_inactive","reset_mac"].includes(g)&&a.jsxs("div",{className:"form-control",children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:null==(p=$.find(e=>e.value===g))?void 0:p.label})}),(()=>{switch(g){case"set_expiry":return a.jsx("input",{type:"date",className:"input input-bordered w-full",value:f,onChange:e=>y(e.target.value)});case"set_service":return a.jsxs("select",{className:"select select-bordered w-full",value:f,onChange:e=>y(e.target.value),children:[a.jsx("option",{value:"",children:"Select service"}),null==M?void 0:M.map(e=>a.jsx("option",{value:e.id,children:e.name},e.id))]});case"set_reseller":return a.jsxs("select",{className:"select select-bordered w-full",value:f,onChange:e=>y(e.target.value),children:[a.jsx("option",{value:"",children:"Select reseller"}),null==R?void 0:R.map(e=>{var l;return a.jsx("option",{value:e.id,children:(null==(l=e.User)?void 0:l.username)||e.company_name},e.id)})]});case"set_monthly_quota":return a.jsx("input",{type:"number",className:"input input-bordered w-full",placeholder:"Quota in GB",value:f,onChange:e=>y(e.target.value)});case"set_daily_quota":return a.jsx("input",{type:"number",className:"input input-bordered w-full",placeholder:"Quota in MB",value:f,onChange:e=>y(e.target.value)});case"set_price":return a.jsx("input",{type:"number",step:"0.01",className:"input input-bordered w-full",placeholder:"Price",value:f,onChange:e=>y(e.target.value)});default:return null}})()]})]}),a.jsx("div",{className:"divider",children:"Custom Filters"}),a.jsxs("div",{className:"flex gap-2 items-end flex-wrap",children:[a.jsxs("div",{className:"form-control",children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"Field"})}),a.jsx("select",{className:"select select-bordered select-sm",value:w.field,onChange:e=>S({...w,field:e.target.value}),children:L.map(e=>a.jsx("option",{value:e.value,children:e.label},e.value))})]}),a.jsxs("div",{className:"form-control",children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"Rule"})}),a.jsx("select",{className:"select select-bordered select-sm",value:w.rule,onChange:e=>S({...w,rule:e.target.value}),children:D.map(e=>a.jsx("option",{value:e.value,children:e.label},e.value))})]}),a.jsxs("div",{className:"form-control",children:[a.jsx("label",{className:"label",children:a.jsx("span",{className:"label-text",children:"Value"})}),a.jsx("input",{type:"text",className:"input input-bordered input-sm",value:w.value,onChange:e=>S({...w,value:e.target.value}),placeholder:"Filter value"})]}),a.jsx("button",{className:"btn btn-primary btn-sm",onClick:()=>{w.value.trim()&&(C([..._,{...w}]),S({field:"username",rule:"like",value:""}))},children:a.jsx(t,{className:"w-4 h-4"})})]}),_.length>0&&a.jsx("div",{className:"flex flex-wrap gap-2 mt-4",children:_.map((e,l)=>{var s,r;return a.jsxs("div",{className:"badge badge-lg gap-2",children:[a.jsx("span",{children:null==(s=L.find(l=>l.value===e.field))?void 0:s.label}),a.jsx("span",{className:"text-xs opacity-70",children:null==(r=D.find(l=>l.value===e.rule))?void 0:r.label}),a.jsx("span",{className:"font-semibold",children:e.value}),a.jsx("button",{className:"btn btn-ghost btn-xs",onClick:()=>{return e=l,void C(_.filter((l,a)=>a!==e));var e},children:a.jsx(m,{className:"w-3 h-3"})})]},l)})}),a.jsxs("div",{className:"flex gap-2 mt-6",children:[a.jsxs("button",{className:"btn btn-success",onClick:()=>{if(!g)return void v.error("Please select an action");if(["set_expiry","set_service","set_reseller","set_monthly_quota","set_daily_quota","set_price"].includes(g)&&!f)return void v.error("Please enter a value for the action");const e={...b,action:g,action_value:f,filters:_};U.mutate(e)},disabled:!g||U.isPending,children:[a.jsx(h,{className:"w-4 h-4"}),U.isPending?"Executing...":"Execute"]}),a.jsxs("button",{className:"btn btn-outline",onClick:V,disabled:B.isPending,children:[a.jsx(x,{className:"w-4 h-4"}),B.isPending?"Loading...":"Preview"]})]})]})}),k&&a.jsx("div",{className:"card bg-base-100 shadow",children:a.jsxs("div",{className:"card-body",children:[a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsxs("h2",{className:"card-title text-lg",children:["Preview (",q," subscribers affected)"]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-sm",children:"Page size:"}),a.jsxs("select",{className:"select select-bordered select-sm",value:E,onChange:e=>{I(parseInt(e.target.value)),K(1)},children:[a.jsx("option",{value:10,children:"10"}),a.jsx("option",{value:30,children:"30"}),a.jsx("option",{value:50,children:"50"}),a.jsx("option",{value:100,children:"100"})]})]})]}),a.jsx("div",{className:"overflow-x-auto",children:a.jsxs("table",{className:"table table-zebra",children:[a.jsx("thead",{children:G.getHeaderGroups().map(e=>a.jsx("tr",{children:e.headers.map(e=>a.jsx("th",{children:o(e.column.columnDef.header,e.getContext())},e.id))},e.id))}),a.jsx("tbody",{children:G.getRowModel().rows.map(e=>a.jsx("tr",{children:e.getVisibleCells().map(e=>a.jsx("td",{children:o(e.column.columnDef.cell,e.getContext())},e.id))},e.id))})]})}),q>E&&a.jsxs("div",{className:"flex justify-center gap-2 mt-4",children:[a.jsx("button",{className:"btn btn-sm",disabled:1===A,onClick:()=>{K(A-1),V()},children:"Previous"}),a.jsxs("span",{className:"flex items-center px-4",children:["Page ",A," of ",Math.ceil(q/E)]}),a.jsx("button",{className:"btn btn-sm",disabled:A>=Math.ceil(q/E),onClick:()=>{K(A+1),V()},children:"Next"})]})]})})]})}export{p as default};
