import{b as e,u as s,d as t,j as a}from"./data-vendor-C6mPcuPT.js";import{r as n}from"./react-vendor-C4Xey-hE.js";import{G as r,S as l,a as i,v as c,q as d,J as o,F as m,T as x,g as u,U as h}from"./index-DmOIf-MM.js";import{u as g,f as p,b as j,a as N}from"./table-vendor-BZVOk-Gl.js";import{c as f,z as v}from"./ui-vendor-CMKyyIMz.js";import{F as y}from"./XCircleIcon-ngg1M-ll.js";import{F as b}from"./MagnifyingGlassIcon-D7UyJAmN.js";import"./chart-vendor-Be69IwoK.js";function w({title:e,titleId:s,...t},a){return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:a,"aria-labelledby":s},t),e?n.createElement("title",{id:s},e):null,n.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 17.25v1.007a3 3 0 0 1-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0 1 15 18.257V17.25m6-12V15a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 15V5.25m18 0A2.25 2.25 0 0 0 18.75 3H5.25A2.25 2.25 0 0 0 3 5.25m18 0V12a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 12V5.25"}))}const T=n.forwardRef(w);function L({title:e,titleId:s,...t},a){return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:a,"aria-labelledby":s},t),e?n.createElement("title",{id:s},e):null,n.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z"}))}const _=n.forwardRef(L);function k(){const{companyName:w}=r(),L=w||"ISP",[k,R]=n.useState(""),[S,C]=n.useState(!1),[D,A]=n.useState(!1);e();const{data:M,isLoading:F,refetch:H,isFetching:W}=s({queryKey:["sharing-detection"],queryFn:()=>h.list().then(e=>e.data),refetchInterval:6e4}),{data:q,refetch:E,isLoading:I}=s({queryKey:["sharing-nas-rules"],queryFn:()=>h.getNasRuleStatus().then(e=>e.data),enabled:D}),K=t({mutationFn:e=>h.generateTTLRules(e),onSuccess:(e,s)=>{var t;v.success((null==(t=e.data)?void 0:t.message)||"TTL rules generated successfully"),E()},onError:e=>{var s,t;v.error((null==(t=null==(s=e.response)?void 0:s.data)?void 0:t.message)||"Failed to generate rules")}}),P=t({mutationFn:e=>h.removeTTLRules(e),onSuccess:e=>{var s;v.success((null==(s=e.data)?void 0:s.message)||"TTL rules removed successfully"),E()},onError:e=>{var s,t;v.error((null==(t=null==(s=e.response)?void 0:s.data)?void 0:t.message)||"Failed to remove rules")}}),V=(null==M?void 0:M.data)||[],O=(null==M?void 0:M.stats)||{},G=(null==q?void 0:q.data)||[],B=n.useMemo(()=>{let e=V;if(S&&(e=e.filter(e=>"high"===e.suspicion_level||"medium"===e.suspicion_level)),k){const s=k.toLowerCase();e=e.filter(e=>{var t,a,n;return(null==(t=e.username)?void 0:t.toLowerCase().includes(s))||(null==(a=e.full_name)?void 0:a.toLowerCase().includes(s))||(null==(n=e.ip_address)?void 0:n.includes(s))})}return e},[V,k,S]),$=n.useMemo(()=>[{accessorKey:"username",header:"Subscriber",cell:({row:e})=>a.jsxs("div",{className:"flex flex-col",children:[a.jsx("span",{className:"font-medium",children:e.original.username}),e.original.full_name&&a.jsx("span",{className:"text-xs text-gray-500",children:e.original.full_name})]})},{accessorKey:"ip_address",header:"IP Address",cell:({row:e})=>a.jsx("code",{className:"px-2 py-1 bg-gray-100 rounded text-sm",children:e.original.ip_address||"-"})},{accessorKey:"connection_count",header:"Connections",cell:({row:e})=>{const s=e.original.connection_count||0;return a.jsx("span",{className:f("font-mono font-medium",s>=400?"text-red-600":s>=200?"text-yellow-600":"text-gray-700"),children:s})}},{accessorKey:"ttl_status",header:"TTL Status",cell:({row:e})=>{return s=e.original.ttl_status,t=e.original.ttl_values,"router_detected"===s?a.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 text-xs font-medium bg-red-100 text-red-700 rounded-full",children:[a.jsx(u,{className:"w-3 h-3"}),"Router Detected"]}):"multiple_os"===s?a.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-700 rounded-full",children:[a.jsx(T,{className:"w-3 h-3"}),"Multiple OS"]}):t&&t.length>0?a.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 text-xs font-medium bg-gray-100 text-gray-600 rounded-full",children:["TTL: ",t.join(", ")]}):a.jsx("span",{className:"text-xs text-gray-400",children:"No TTL data"});var s,t}},{accessorKey:"suspicion_level",header:"Risk Level",cell:({row:e})=>function(e){switch(e){case"high":return a.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 text-xs font-medium bg-red-100 text-red-700 rounded-full",children:[a.jsx(x,{className:"w-3 h-3"}),"High Risk"]});case"medium":return a.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-700 rounded-full",children:[a.jsx(o,{className:"w-3 h-3"}),"Medium"]});default:return a.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 text-xs font-medium bg-green-100 text-green-700 rounded-full",children:[a.jsx(m,{className:"w-3 h-3"}),"Normal"]})}}(e.original.suspicion_level)},{accessorKey:"reasons",header:"Reasons",cell:({row:e})=>{const s=e.original.reasons||[];return 0===s.length?a.jsx("span",{className:"text-gray-400",children:"-"}):a.jsxs("div",{className:"max-w-xs",children:[s.slice(0,2).map((e,s)=>a.jsx("div",{className:"text-xs text-gray-600 truncate",children:e},s)),s.length>2&&a.jsxs("span",{className:"text-xs text-gray-400",children:["+",s.length-2," more"]})]})}},{accessorKey:"nas_name",header:"NAS",cell:({row:e})=>a.jsx("span",{className:"text-sm text-gray-600",children:e.original.nas_name||e.original.nas_ip_address||"-"})}],[]),z=g({data:B,columns:$,getCoreRowModel:N(),getFilteredRowModel:j()});return a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Sharing Detection"}),a.jsx("p",{className:"text-gray-500",children:"Detect accounts that may be shared with multiple users"})]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsxs("button",{onClick:()=>A(!D),className:"btn-secondary flex items-center gap-2",children:[a.jsx(l,{className:"w-4 h-4"}),"Configure TTL Rules"]}),a.jsxs("button",{onClick:()=>H(),disabled:W,className:"btn-secondary flex items-center gap-2",children:[a.jsx(i,{className:f("w-4 h-4",W&&"animate-spin")}),W?"Analyzing...":"Refresh"]})]})]}),D&&a.jsxs("div",{className:"card p-6 border-2 border-primary-200 bg-primary-50",children:[a.jsxs("div",{className:"flex items-start justify-between mb-4",children:[a.jsxs("div",{children:[a.jsxs("h2",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[a.jsx(l,{className:"w-5 h-5 text-primary-600"}),"TTL Detection Rules Configuration"]}),a.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"TTL (Time To Live) detection identifies when a customer is using a router/NAT device to share their connection. When packets pass through a router, the TTL value decreases by 1."})]}),a.jsx("button",{onClick:()=>A(!1),className:"text-gray-400 hover:text-gray-600",children:a.jsx(y,{className:"w-5 h-5"})})]}),a.jsxs("div",{className:"bg-white rounded-lg p-4 mb-4",children:[a.jsx("h3",{className:"font-medium text-gray-800 mb-2",children:"How TTL Detection Works:"}),a.jsxs("ul",{className:"text-sm text-gray-600 space-y-1 list-disc list-inside",children:[a.jsxs("li",{children:[a.jsx("strong",{children:"TTL = 128:"})," Direct Windows connection (no router)"]}),a.jsxs("li",{children:[a.jsx("strong",{children:"TTL = 127:"})," Windows device behind a router (128 - 1)"]}),a.jsxs("li",{children:[a.jsx("strong",{children:"TTL = 64:"})," Direct Linux/Android/iOS connection (no router)"]}),a.jsxs("li",{children:[a.jsx("strong",{children:"TTL = 63:"})," Linux/Android/iOS device behind a router (64 - 1)"]})]}),a.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"When we detect TTL=127 or TTL=63, it means the customer is using a router/NAT to share their connection with other devices."})]}),a.jsx("h3",{className:"font-medium text-gray-800 mb-3",children:"NAS Devices - TTL Rule Status:"}),I?a.jsx("div",{className:"flex items-center justify-center py-8",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"})}):0===G.length?a.jsx("p",{className:"text-gray-500 text-center py-4",children:"No active NAS devices found"}):a.jsx("div",{className:"grid gap-3",children:G.map(e=>a.jsxs("div",{className:"flex items-center justify-between bg-white p-4 rounded-lg border",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(c,{className:"w-5 h-5 text-gray-400"}),a.jsxs("div",{children:[a.jsx("div",{className:"font-medium text-gray-900",children:e.nas_name}),a.jsx("div",{className:"text-sm text-gray-500",children:e.nas_ip_address})]})]}),a.jsxs("div",{className:"flex items-center gap-4",children:[e.error?a.jsxs("span",{className:"text-sm text-red-600 flex items-center gap-1",children:[a.jsx(y,{className:"w-4 h-4"}),"Error: ",e.error]}):e.rules_configured?a.jsxs("span",{className:"text-sm text-green-600 flex items-center gap-1",children:[a.jsx(d,{className:"w-4 h-4"}),e.rule_count," rules configured"]}):a.jsxs("span",{className:"text-sm text-yellow-600 flex items-center gap-1",children:[a.jsx(o,{className:"w-4 h-4"}),"Not configured (",e.rule_count," rules)"]}),a.jsx("div",{className:"flex gap-2",children:e.rules_configured?a.jsx("button",{onClick:()=>P.mutate(e.nas_id),disabled:P.isPending,className:"btn-danger text-sm px-3 py-1.5",children:P.isPending?"Removing...":"Remove Rules"}):a.jsx("button",{onClick:()=>K.mutate(e.nas_id),disabled:K.isPending,className:"btn-primary text-sm px-3 py-1.5",children:K.isPending?"Generating...":"Generate TTL Rules"})})]})]},e.nas_id))}),a.jsx("div",{className:"mt-4 flex justify-end",children:a.jsxs("button",{onClick:()=>E(),className:"btn-secondary text-sm flex items-center gap-2",children:[a.jsx(i,{className:"w-4 h-4"}),"Refresh Status"]})})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[a.jsx("div",{className:"card p-4",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:a.jsx(m,{className:"w-5 h-5 text-blue-600"})}),a.jsxs("div",{children:[a.jsx("div",{className:"text-sm text-gray-500",children:"Online Users"}),a.jsx("div",{className:"text-2xl font-bold",children:O.total_online||0})]})]})}),a.jsx("div",{className:"card p-4",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"p-2 bg-yellow-100 rounded-lg",children:a.jsx(o,{className:"w-5 h-5 text-yellow-600"})}),a.jsxs("div",{children:[a.jsx("div",{className:"text-sm text-gray-500",children:"Suspicious"}),a.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:O.suspicious_count||0})]})]})}),a.jsx("div",{className:"card p-4",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"p-2 bg-red-100 rounded-lg",children:a.jsx(x,{className:"w-5 h-5 text-red-600"})}),a.jsxs("div",{children:[a.jsx("div",{className:"text-sm text-gray-500",children:"High Risk"}),a.jsx("div",{className:"text-2xl font-bold text-red-600",children:O.high_risk_count||0})]})]})}),a.jsx("div",{className:"card p-4",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:a.jsx(u,{className:"w-5 h-5 text-purple-600"})}),a.jsxs("div",{children:[a.jsx("div",{className:"text-sm text-gray-500",children:"Router Detected"}),a.jsx("div",{className:"text-2xl font-bold text-purple-600",children:O.router_detected||0})]})]})}),a.jsx("div",{className:"card p-4",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"p-2 bg-orange-100 rounded-lg",children:a.jsx(T,{className:"w-5 h-5 text-orange-600"})}),a.jsxs("div",{children:[a.jsx("div",{className:"text-sm text-gray-500",children:"High Connections"}),a.jsx("div",{className:"text-2xl font-bold text-orange-600",children:O.high_connections||0})]})]})})]}),a.jsx("div",{className:"card p-4 bg-blue-50 border-blue-200",children:a.jsxs("div",{className:"flex gap-3",children:[a.jsx(_,{className:"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"}),a.jsxs("div",{className:"text-sm text-blue-800",children:[a.jsx("p",{className:"font-medium mb-1",children:"How Detection Works:"}),a.jsxs("ul",{className:"list-disc list-inside space-y-1 text-blue-700",children:[a.jsxs("li",{children:[a.jsx("strong",{children:"TTL Detection:"})," TTL=127 or 63 indicates a router behind customer's connection (normal is 128 or 64)"]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Connection Count:"})," More than 200 connections may indicate multiple users"]}),a.jsxs("li",{children:[a.jsx("strong",{children:"High Risk:"})," Both router detected AND high connection count"]})]}),a.jsx("p",{className:"mt-2 text-blue-600",children:"Note: For TTL detection to work, add mangle rules on MikroTik to mark connections by TTL."})]})]})}),a.jsx("div",{className:"card p-4",children:a.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[a.jsxs("div",{className:"relative flex-1 max-w-md",children:[a.jsx(b,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),a.jsx("input",{type:"text",placeholder:"Search by username, name, IP...",value:k,onChange:e=>R(e.target.value),className:"input pl-10"})]}),a.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[a.jsx("input",{type:"checkbox",checked:S,onChange:e=>C(e.target.checked),className:"w-4 h-4 text-primary-600 rounded border-gray-300 focus:ring-primary-500"}),a.jsx("span",{className:"text-sm text-gray-700",children:"Show only suspicious accounts"})]})]})}),a.jsx("div",{className:"card",children:a.jsx("div",{className:"table-container",children:a.jsxs("table",{className:"table",children:[a.jsx("thead",{children:z.getHeaderGroups().map(e=>a.jsx("tr",{children:e.headers.map(e=>a.jsx("th",{children:p(e.column.columnDef.header,e.getContext())},e.id))},e.id))}),a.jsx("tbody",{className:"divide-y divide-gray-200",children:F?a.jsx("tr",{children:a.jsx("td",{colSpan:$.length,className:"text-center py-8",children:a.jsxs("div",{className:"flex flex-col items-center justify-center gap-2",children:[a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"}),a.jsx("span",{className:"text-gray-500",children:"Analyzing connections..."})]})})}):0===z.getRowModel().rows.length?a.jsx("tr",{children:a.jsx("td",{colSpan:$.length,className:"text-center py-8 text-gray-500",children:S?"No suspicious accounts found":"No online users"})}):z.getRowModel().rows.map(e=>a.jsx("tr",{className:f("hover:bg-gray-50","high"===e.original.suspicion_level&&"bg-red-50","medium"===e.original.suspicion_level&&"bg-yellow-50"),children:e.getVisibleCells().map(e=>a.jsx("td",{children:p(e.column.columnDef.cell,e.getContext())},e.id))},e.id))})]})})}),a.jsxs("details",{className:"card p-4",children:[a.jsxs("summary",{className:"font-medium text-gray-900 cursor-pointer flex items-center gap-2",children:[a.jsx(_,{className:"w-5 h-5 text-gray-400"}),"Manual MikroTik TTL Detection Setup (Advanced)"]}),a.jsxs("div",{className:"mt-3",children:[a.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"If you prefer to add the rules manually instead of using the automatic configuration above, use these commands:"}),a.jsx("pre",{className:"bg-gray-900 text-green-400 p-4 rounded-lg text-sm overflow-x-auto",children:`/ip firewall mangle\nadd chain=prerouting action=mark-connection new-connection-mark=ttl_128 ttl=equal:128 passthrough=yes comment="${L}-TTL-Detection - Direct Windows"\nadd chain=prerouting action=mark-connection new-connection-mark=ttl_127 ttl=equal:127 passthrough=yes comment="${L}-TTL-Detection - Windows behind router"\nadd chain=prerouting action=mark-connection new-connection-mark=ttl_64 ttl=equal:64 passthrough=yes comment="${L}-TTL-Detection - Direct Linux/Android"\nadd chain=prerouting action=mark-connection new-connection-mark=ttl_63 ttl=equal:63 passthrough=yes comment="${L}-TTL-Detection - Linux/Android behind router"`})]})]})]})}export{k as default};
