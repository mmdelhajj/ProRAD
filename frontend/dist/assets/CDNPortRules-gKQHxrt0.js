import{b as e,u as s,d as a,j as r}from"./data-vendor-Gi89QHLZ.js";import{r as t}from"./react-vendor-C1B6conR.js";import{a as n,c as l,a1 as d,j as i,v as c,n as o}from"./index-B6bRFGWQ.js";import{c as m,z as u}from"./ui-vendor-Bljr83Cq.js";import{F as p}from"./PencilIcon-BjNR2RGb.js";import{F as x}from"./TrashIcon-BFqTFmN6.js";import"./chart-vendor-C_esy2x0.js";const h=[{value:"src",label:"Source Port Only (src-port)"},{value:"dst",label:"Destination Port Only (dst-port)"},{value:"both",label:"Both (src-port + dst-port)"},{value:"dscp",label:"DSCP Only (no port)"}],b={name:"",port:"",direction:"both",dscp_value:63,speed_mbps:5,nas_id:null,is_active:!0};function g(){const g=e(),[v,j]=t.useState(!1),[y,N]=t.useState(null),[k,f]=t.useState(b),{data:P,isLoading:_}=s({queryKey:["cdn-port-rules"],queryFn:()=>c.listPortRules().then(e=>e.data.data)}),{data:S}=s({queryKey:["nas"],queryFn:()=>o.list().then(e=>e.data.data)}),C=a({mutationFn:e=>y?c.updatePortRule(y.id,e):c.createPortRule(e),onSuccess:()=>{u.success(y?"Port rule updated":"Port rule created"),g.invalidateQueries({queryKey:["cdn-port-rules"]}),q()},onError:e=>{var s,a;return u.error((null==(a=null==(s=e.response)?void 0:s.data)?void 0:a.message)||"Failed to save")}}),w=a({mutationFn:e=>c.deletePortRule(e),onSuccess:()=>{u.success("Port rule deleted"),g.invalidateQueries({queryKey:["cdn-port-rules"]})},onError:e=>{var s,a;return u.error((null==(a=null==(s=e.response)?void 0:s.data)?void 0:a.message)||"Failed to delete")}}),R=a({mutationFn:e=>c.syncPortRule(e),onSuccess:e=>{var s;return u.success((null==(s=e.data)?void 0:s.message)||"Syncing to MikroTik...")},onError:e=>{var s,a;return u.error((null==(a=null==(s=e.response)?void 0:s.data)?void 0:a.message)||"Sync failed")}}),T=a({mutationFn:()=>c.syncAllPortRules(),onSuccess:e=>{var s;return u.success((null==(s=e.data)?void 0:s.message)||"Syncing all to MikroTik...")},onError:e=>{var s,a;return u.error((null==(a=null==(s=e.response)?void 0:s.data)?void 0:a.message)||"Sync failed")}}),A=(e=null)=>{e?(N(e),f({name:e.name||"",port:e.port||"",direction:e.direction||"both",dscp_value:e.dscp_value??63,speed_mbps:e.speed_mbps||5,nas_id:e.nas_id||null,is_active:e.is_active??!0})):(N(null),f(b)),j(!0)},q=()=>{j(!1),N(null)},F=e=>{const{name:s,value:a,type:r,checked:t}=e.target;f(e=>({...e,[s]:"checkbox"===r?t:a}))},D=(e,s)=>"src"===e?"src-port":"dst"===e?"dst-port":"dscp"===e?`dscp=${(null==s?void 0:s.dscp_value)??""}`:"src + dst";return r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"CDN Port Rules"}),r.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Port-based PCQ speed rules applied on MikroTik"})]}),r.jsxs("div",{className:"flex gap-2",children:[r.jsxs("button",{onClick:()=>T.mutate(),disabled:T.isPending,className:"btn-secondary flex items-center gap-2",children:[r.jsx(n,{className:m("w-4 h-4",T.isPending&&"animate-spin")}),T.isPending?"Syncing...":"Sync All to MikroTik"]}),r.jsxs("button",{onClick:()=>A(),className:"btn-primary flex items-center gap-2",children:[r.jsx(l,{className:"w-4 h-4"}),"Add Port Rule"]})]})]}),r.jsx("div",{className:"bg-blue-50 dark:bg-blue-900/30 border border-blue-200 rounded-lg p-4",children:r.jsxs("div",{className:"flex gap-3",children:[r.jsx(d,{className:"w-6 h-6 text-blue-500 flex-shrink-0"}),r.jsxs("div",{children:[r.jsx("h3",{className:"font-medium text-blue-900 dark:text-blue-200",children:"Port-Based Speed Control"}),r.jsx("p",{className:"text-sm text-blue-700 dark:text-blue-300 mt-1",children:"Create PCQ speed rules based on TCP port numbers. Each rule creates a queue type, mangle rules (src-port, dst-port, or both), and a simple queue on MikroTik. No IP subnets needed — rules match by port only."}),r.jsx("p",{className:"text-xs text-blue-600 dark:text-blue-400 mt-1 font-mono",children:"Example: Port 8080 → mark-packet PORT-SP → PCQ queue 5Mbps"})]})]})}),r.jsx("div",{className:"card",children:r.jsx("div",{className:"table-container",children:r.jsxs("table",{className:"table",children:[r.jsx("thead",{children:r.jsxs("tr",{children:[r.jsx("th",{children:"Name"}),r.jsx("th",{children:"Port"}),r.jsx("th",{children:"Direction"}),r.jsx("th",{children:"Speed"}),r.jsx("th",{children:"NAS"}),r.jsx("th",{children:"Status"}),r.jsx("th",{children:"Actions"})]})}),r.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:_?r.jsx("tr",{children:r.jsx("td",{colSpan:7,className:"text-center py-8",children:r.jsx("div",{className:"flex items-center justify-center",children:r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"})})})}):P&&0!==P.length?P.map(e=>{var s,a;return r.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700",children:[r.jsx("td",{children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("div",{className:"p-1.5 bg-orange-100 rounded-lg",children:r.jsx(d,{className:"w-4 h-4 text-orange-600"})}),r.jsx("span",{className:"font-semibold text-gray-900 dark:text-white",children:e.name})]})}),r.jsx("td",{children:"dscp"===e.direction?r.jsxs("span",{className:"font-mono text-sm bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 px-2 py-1 rounded",children:["DSCP ",e.dscp_value]}):r.jsxs("span",{className:"font-mono text-sm bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded",children:[":",e.port]})}),r.jsx("td",{children:r.jsx("span",{className:m("text-xs font-medium px-2 py-1 rounded-full",(a=e.direction,"src"===a?"bg-blue-100 text-blue-800":"dst"===a?"bg-purple-100 text-purple-800":"dscp"===a?"bg-orange-100 text-orange-800":"bg-green-100 text-green-800")),children:D(e.direction,e)})}),r.jsx("td",{children:r.jsxs("span",{className:"font-semibold text-gray-900 dark:text-white",children:[e.speed_mbps," Mbps"]})}),r.jsx("td",{children:r.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:e.nas_id?(null==(s=null==S?void 0:S.find(s=>s.id===e.nas_id))?void 0:s.name)||`NAS #${e.nas_id}`:"All NAS"})}),r.jsx("td",{children:r.jsx("span",{className:m("badge",e.is_active?"badge-success":"badge-gray"),children:e.is_active?"Active":"Inactive"})}),r.jsx("td",{children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("button",{onClick:()=>R.mutate(e.id),disabled:!e.is_active||R.isPending,className:m("p-1.5 rounded",e.is_active?"text-gray-500 hover:text-green-600 hover:bg-green-50":"text-gray-300 cursor-not-allowed"),title:e.is_active?"Sync to MikroTik":"Rule is inactive",children:r.jsx(n,{className:m("w-4 h-4",R.isPending&&"animate-spin")})}),r.jsx("button",{onClick:()=>A(e),className:"p-1.5 text-gray-500 hover:text-primary-600 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded",title:"Edit",children:r.jsx(p,{className:"w-4 h-4"})}),r.jsx("button",{onClick:()=>{confirm("Delete this port rule?")&&w.mutate(e.id)},className:"p-1.5 text-gray-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30 rounded",title:"Delete",children:r.jsx(x,{className:"w-4 h-4"})})]})})]},e.id)}):r.jsx("tr",{children:r.jsx("td",{colSpan:7,className:"text-center py-8 text-gray-500 dark:text-gray-400",children:'No port rules found. Click "Add Port Rule" to create one.'})})})]})})}),v&&r.jsx("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:r.jsxs("div",{className:"flex items-center justify-center min-h-screen px-4",children:[r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50",onClick:q}),r.jsxs("div",{className:"relative bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full",children:[r.jsxs("div",{className:"flex items-center justify-between p-6 border-b dark:border-gray-700",children:[r.jsx("h2",{className:"text-xl font-semibold dark:text-white",children:y?"Edit Port Rule":"Add Port Rule"}),r.jsx("button",{onClick:q,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg",children:r.jsx(i,{className:"w-5 h-5"})})]}),r.jsxs("form",{onSubmit:e=>{e.preventDefault();const s={...k,speed_mbps:parseInt(k.speed_mbps)||5,nas_id:k.nas_id?parseInt(k.nas_id):null};"dscp"===k.direction?(s.dscp_value=parseInt(k.dscp_value)||0,s.port=""):s.dscp_value=null,C.mutate(s)},className:"p-6 space-y-4",children:[r.jsxs("div",{children:[r.jsx("label",{className:"label",children:"Rule Name"}),r.jsx("input",{type:"text",name:"name",value:k.name,onChange:F,className:"input",placeholder:"e.g. SP, YouTube, Cache",required:!0})]}),r.jsxs("div",{children:[r.jsx("label",{className:"label",children:"Direction"}),r.jsx("select",{name:"direction",value:k.direction,onChange:F,className:"input",children:h.map(e=>r.jsx("option",{value:e.value,children:e.label},e.value))}),r.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["src"===k.direction&&"Generates: src-port mangle rule (chain=forward)","dst"===k.direction&&"Generates: dst-port mangle rule (chain=forward)","both"===k.direction&&"Generates: src-port + dst-port mangle rules (chain=forward)","dscp"===k.direction&&"Generates: DSCP mangle rule (chain=postrouting, no port)"]})]}),"dscp"!==k.direction?r.jsxs("div",{children:[r.jsx("label",{className:"label",children:"Port"}),r.jsx("input",{type:"text",name:"port",value:k.port,onChange:F,className:"input font-mono",placeholder:"e.g. 8080",required:!0}),r.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"TCP port number to match"})]}):r.jsxs("div",{children:[r.jsx("label",{className:"label",children:"DSCP Value (0–63)"}),r.jsx("input",{type:"number",name:"dscp_value",value:k.dscp_value,onChange:F,className:"input font-mono",placeholder:"e.g. 63",min:"0",max:"63",required:!0}),r.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"DSCP value to match (0–63). Common values: 46=EF, 34=AF41, 63=custom"})]}),r.jsxs("div",{children:[r.jsx("label",{className:"label",children:"Speed Limit (Mbps)"}),r.jsx("input",{type:"number",name:"speed_mbps",value:k.speed_mbps,onChange:F,className:"input",min:"1",required:!0})]}),r.jsxs("div",{children:[r.jsx("label",{className:"label",children:"Apply to NAS"}),r.jsxs("select",{name:"nas_id",value:k.nas_id||"",onChange:e=>f(s=>({...s,nas_id:e.target.value||null})),className:"input",children:[r.jsx("option",{value:"",children:"All NAS"}),null==S?void 0:S.filter(e=>e.is_active).map(e=>r.jsxs("option",{value:e.id,children:[e.name," (",e.ip_address,")"]},e.id))]})]}),r.jsx("div",{children:r.jsxs("label",{className:"flex items-center gap-3",children:[r.jsx("input",{type:"checkbox",name:"is_active",checked:k.is_active,onChange:F,className:"rounded border-gray-300 text-primary-600 focus:ring-primary-500"}),r.jsx("span",{className:"dark:text-white",children:"Active"})]})}),k.name&&("dscp"===k.direction||k.port)&&r.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-3 font-mono text-xs text-gray-600 dark:text-gray-300 space-y-1",children:[r.jsx("div",{className:"text-gray-400 mb-1",children:"MikroTik preview:"}),r.jsxs("div",{children:["queue type: PORT-",k.name,"-",k.speed_mbps," (",k.speed_mbps,"M PCQ)"]}),"dscp"===k.direction?r.jsxs("div",{children:["mangle: chain=postrouting dscp=",k.dscp_value," new-packet-mark=PORT-",k.name," passthrough=no"]}):r.jsxs(r.Fragment,{children:[("src"===k.direction||"both"===k.direction)&&r.jsxs("div",{children:["mangle: chain=forward protocol=tcp src-port=",k.port," mark=PORT-",k.name]}),("dst"===k.direction||"both"===k.direction)&&r.jsxs("div",{children:["mangle: chain=forward protocol=tcp dst-port=",k.port," mark=PORT-",k.name]})]}),r.jsxs("div",{children:["queue: PORT-",k.name,"-",k.speed_mbps,"M (packet-mark=PORT-",k.name,")"]})]}),r.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t dark:border-gray-700",children:[r.jsx("button",{type:"button",onClick:q,className:"btn-secondary",children:"Cancel"}),r.jsx("button",{type:"submit",disabled:C.isPending,className:"btn-primary",children:C.isPending?"Saving...":y?"Update":"Create"})]})]})]})]})})]})}export{g as default};
