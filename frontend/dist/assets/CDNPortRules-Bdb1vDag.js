import{b as e,u as s,d as a,j as r}from"./data-vendor-DrqtOFCb.js";import{r as t}from"./react-vendor-_qYBQpt5.js";import{a as n,c as l,a2 as i,o as d,j as c,v as o,n as p}from"./index-BK1myTbb.js";import{c as m,z as x}from"./ui-vendor-C17HITwC.js";import{F as h}from"./PencilIcon-D49jQy4Q.js";import{F as u}from"./TrashIcon-3C89j8Vq.js";import"./chart-vendor-CsTzT1mg.js";const g=[{value:"src",label:"Source Port Only (src-port)"},{value:"dst",label:"Destination Port Only (dst-port)"},{value:"both",label:"Both (src-port + dst-port)"},{value:"dscp",label:"DSCP Only (no port)"}],b=["#8B5CF6","#EF4444","#3B82F6","#10B981","#F59E0B","#EC4899","#06B6D4","#84CC16"],j={name:"",port:"",direction:"both",dscp_value:63,speed_mbps:5,nas_id:null,is_active:!0,show_in_graph:!1,color:"#8B5CF6"};function v(){const v=e(),[y,N]=t.useState(!1),[k,f]=t.useState(null),[_,w]=t.useState(j),{data:C,isLoading:P}=s({queryKey:["cdn-port-rules"],queryFn:()=>o.listPortRules().then(e=>e.data.data)}),{data:S}=s({queryKey:["nas"],queryFn:()=>p.list().then(e=>e.data.data)}),F=a({mutationFn:e=>k?o.updatePortRule(k.id,e):o.createPortRule(e),onSuccess:()=>{x.success(k?"Port rule updated":"Port rule created"),v.invalidateQueries({queryKey:["cdn-port-rules"]}),D()},onError:e=>{var s,a;return x.error((null==(a=null==(s=e.response)?void 0:s.data)?void 0:a.message)||"Failed to save")}}),R=a({mutationFn:e=>o.deletePortRule(e),onSuccess:()=>{x.success("Port rule deleted"),v.invalidateQueries({queryKey:["cdn-port-rules"]})},onError:e=>{var s,a;return x.error((null==(a=null==(s=e.response)?void 0:s.data)?void 0:a.message)||"Failed to delete")}}),T=a({mutationFn:e=>o.syncPortRule(e),onSuccess:e=>{var s;return x.success((null==(s=e.data)?void 0:s.message)||"Syncing to MikroTik...")},onError:e=>{var s,a;return x.error((null==(a=null==(s=e.response)?void 0:s.data)?void 0:a.message)||"Sync failed")}}),A=a({mutationFn:()=>o.syncAllPortRules(),onSuccess:e=>{var s;return x.success((null==(s=e.data)?void 0:s.message)||"Syncing all to MikroTik...")},onError:e=>{var s,a;return x.error((null==(a=null==(s=e.response)?void 0:s.data)?void 0:a.message)||"Sync failed")}}),q=(e=null)=>{e?(f(e),w({name:e.name||"",port:e.port||"",direction:e.direction||"both",dscp_value:e.dscp_value??63,speed_mbps:e.speed_mbps||5,nas_id:e.nas_id||null,is_active:e.is_active??!0,show_in_graph:e.show_in_graph??!1,color:e.color||"#8B5CF6"})):(f(null),w(j)),N(!0)},D=()=>{N(!1),f(null)},B=e=>{const{name:s,value:a,type:r,checked:t}=e.target;w(e=>({...e,[s]:"checkbox"===r?t:a}))},E=(e,s)=>"src"===e?"src-port":"dst"===e?"dst-port":"dscp"===e?`dscp=${(null==s?void 0:s.dscp_value)??""}`:"src + dst";return r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"CDN Port Rules"}),r.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Port-based PCQ speed rules applied on MikroTik"})]}),r.jsxs("div",{className:"flex gap-2",children:[r.jsxs("button",{onClick:()=>A.mutate(),disabled:A.isPending,className:"btn-secondary flex items-center gap-2",children:[r.jsx(n,{className:m("w-4 h-4",A.isPending&&"animate-spin")}),A.isPending?"Syncing...":"Sync All to MikroTik"]}),r.jsxs("button",{onClick:()=>q(),className:"btn-primary flex items-center gap-2",children:[r.jsx(l,{className:"w-4 h-4"}),"Add Port Rule"]})]})]}),r.jsx("div",{className:"bg-blue-50 dark:bg-blue-900/30 border border-blue-200 rounded-lg p-4",children:r.jsxs("div",{className:"flex gap-3",children:[r.jsx(i,{className:"w-6 h-6 text-blue-500 flex-shrink-0"}),r.jsxs("div",{children:[r.jsx("h3",{className:"font-medium text-blue-900 dark:text-blue-200",children:"Port-Based Speed Control"}),r.jsx("p",{className:"text-sm text-blue-700 dark:text-blue-300 mt-1",children:"Create PCQ speed rules based on TCP port numbers. Each rule creates a queue type, mangle rules (src-port, dst-port, or both), and a simple queue on MikroTik. No IP subnets needed — rules match by port only."}),r.jsx("p",{className:"text-xs text-blue-600 dark:text-blue-400 mt-1 font-mono",children:"Example: Port 8080 → mark-packet PORT-SP → PCQ queue 5Mbps"})]})]})}),r.jsx("div",{className:"card",children:r.jsx("div",{className:"table-container",children:r.jsxs("table",{className:"table",children:[r.jsx("thead",{children:r.jsxs("tr",{children:[r.jsx("th",{children:"Name"}),r.jsx("th",{children:"Port"}),r.jsx("th",{children:"Direction"}),r.jsx("th",{children:"Speed"}),r.jsx("th",{children:"NAS"}),r.jsx("th",{children:"Status"}),r.jsx("th",{children:"Graph"}),r.jsx("th",{children:"Actions"})]})}),r.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:P?r.jsx("tr",{children:r.jsx("td",{colSpan:8,className:"text-center py-8",children:r.jsx("div",{className:"flex items-center justify-center",children:r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"})})})}):C&&0!==C.length?C.map(e=>{var s,a;return r.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700",children:[r.jsx("td",{children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("div",{className:"p-1.5 bg-orange-100 rounded-lg",children:r.jsx(i,{className:"w-4 h-4 text-orange-600"})}),r.jsx("span",{className:"font-semibold text-gray-900 dark:text-white",children:e.name})]})}),r.jsx("td",{children:"dscp"===e.direction?r.jsxs("span",{className:"font-mono text-sm bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 px-2 py-1 rounded",children:["DSCP ",e.dscp_value]}):r.jsxs("span",{className:"font-mono text-sm bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded",children:[":",e.port]})}),r.jsx("td",{children:r.jsx("span",{className:m("text-xs font-medium px-2 py-1 rounded-full",(a=e.direction,"src"===a?"bg-blue-100 text-blue-800":"dst"===a?"bg-purple-100 text-purple-800":"dscp"===a?"bg-orange-100 text-orange-800":"bg-green-100 text-green-800")),children:E(e.direction,e)})}),r.jsx("td",{children:r.jsxs("span",{className:"font-semibold text-gray-900 dark:text-white",children:[e.speed_mbps," Mbps"]})}),r.jsx("td",{children:r.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:e.nas_id?(null==(s=null==S?void 0:S.find(s=>s.id===e.nas_id))?void 0:s.name)||`NAS #${e.nas_id}`:"All NAS"})}),r.jsx("td",{children:r.jsx("span",{className:m("badge",e.is_active?"badge-success":"badge-gray"),children:e.is_active?"Active":"Inactive"})}),r.jsx("td",{children:e.show_in_graph&&"dscp"!==e.direction?r.jsxs("div",{className:"flex items-center gap-1.5",children:[r.jsx("div",{className:"w-3 h-3 rounded-full flex-shrink-0",style:{backgroundColor:e.color||"#8B5CF6"}}),r.jsx(d,{className:"w-4 h-4",style:{color:e.color||"#8B5CF6"},title:"Shows in live graph"})]}):r.jsx("span",{className:"text-gray-300 dark:text-gray-600 text-xs",children:"—"})}),r.jsx("td",{children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("button",{onClick:()=>T.mutate(e.id),disabled:!e.is_active||T.isPending,className:m("p-1.5 rounded",e.is_active?"text-gray-500 hover:text-green-600 hover:bg-green-50":"text-gray-300 cursor-not-allowed"),title:e.is_active?"Sync to MikroTik":"Rule is inactive",children:r.jsx(n,{className:m("w-4 h-4",T.isPending&&"animate-spin")})}),r.jsx("button",{onClick:()=>q(e),className:"p-1.5 text-gray-500 hover:text-primary-600 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded",title:"Edit",children:r.jsx(h,{className:"w-4 h-4"})}),r.jsx("button",{onClick:()=>{confirm("Delete this port rule?")&&R.mutate(e.id)},className:"p-1.5 text-gray-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30 rounded",title:"Delete",children:r.jsx(u,{className:"w-4 h-4"})})]})})]},e.id)}):r.jsx("tr",{children:r.jsx("td",{colSpan:8,className:"text-center py-8 text-gray-500 dark:text-gray-400",children:'No port rules found. Click "Add Port Rule" to create one.'})})})]})})}),y&&r.jsx("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:r.jsxs("div",{className:"flex items-center justify-center min-h-screen px-4",children:[r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50",onClick:D}),r.jsxs("div",{className:"relative bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full",children:[r.jsxs("div",{className:"flex items-center justify-between p-6 border-b dark:border-gray-700",children:[r.jsx("h2",{className:"text-xl font-semibold dark:text-white",children:k?"Edit Port Rule":"Add Port Rule"}),r.jsx("button",{onClick:D,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg",children:r.jsx(c,{className:"w-5 h-5"})})]}),r.jsxs("form",{onSubmit:e=>{e.preventDefault();const s={..._,speed_mbps:parseInt(_.speed_mbps)||5,nas_id:_.nas_id?parseInt(_.nas_id):null,show_in_graph:_.show_in_graph,color:_.color||"#8B5CF6"};"dscp"===_.direction?(s.dscp_value=parseInt(_.dscp_value)||0,s.port="",s.show_in_graph=!1):s.dscp_value=null,F.mutate(s)},className:"p-6 space-y-4",children:[r.jsxs("div",{children:[r.jsx("label",{className:"label",children:"Rule Name"}),r.jsx("input",{type:"text",name:"name",value:_.name,onChange:B,className:"input",placeholder:"e.g. SP, YouTube, Cache",required:!0})]}),r.jsxs("div",{children:[r.jsx("label",{className:"label",children:"Direction"}),r.jsx("select",{name:"direction",value:_.direction,onChange:B,className:"input",children:g.map(e=>r.jsx("option",{value:e.value,children:e.label},e.value))}),r.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["src"===_.direction&&"Generates: src-port mangle rule (chain=forward)","dst"===_.direction&&"Generates: dst-port mangle rule (chain=forward)","both"===_.direction&&"Generates: src-port + dst-port mangle rules (chain=forward)","dscp"===_.direction&&"Generates: DSCP mangle rule (chain=postrouting, no port)"]})]}),"dscp"!==_.direction?r.jsxs("div",{children:[r.jsx("label",{className:"label",children:"Port"}),r.jsx("input",{type:"text",name:"port",value:_.port,onChange:B,className:"input font-mono",placeholder:"e.g. 8080",required:!0}),r.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"TCP port number to match"})]}):r.jsxs("div",{children:[r.jsx("label",{className:"label",children:"DSCP Value (0–63)"}),r.jsx("input",{type:"number",name:"dscp_value",value:_.dscp_value,onChange:B,className:"input font-mono",placeholder:"e.g. 63",min:"0",max:"63",required:!0}),r.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"DSCP value to match (0–63). Common values: 46=EF, 34=AF41, 63=custom"})]}),r.jsxs("div",{children:[r.jsx("label",{className:"label",children:"Speed Limit (Mbps)"}),r.jsx("input",{type:"number",name:"speed_mbps",value:_.speed_mbps,onChange:B,className:"input",min:"1",required:!0})]}),r.jsxs("div",{children:[r.jsx("label",{className:"label",children:"Apply to NAS"}),r.jsxs("select",{name:"nas_id",value:_.nas_id||"",onChange:e=>w(s=>({...s,nas_id:e.target.value||null})),className:"input",children:[r.jsx("option",{value:"",children:"All NAS"}),null==S?void 0:S.filter(e=>e.is_active).map(e=>r.jsxs("option",{value:e.id,children:[e.name," (",e.ip_address,")"]},e.id))]})]}),r.jsx("div",{children:r.jsxs("label",{className:"flex items-center gap-3",children:[r.jsx("input",{type:"checkbox",name:"is_active",checked:_.is_active,onChange:B,className:"rounded border-gray-300 text-primary-600 focus:ring-primary-500"}),r.jsx("span",{className:"dark:text-white",children:"Active"})]})}),"dscp"!==_.direction&&r.jsxs("div",{className:"border-t dark:border-gray-700 pt-4 space-y-3",children:[r.jsx("div",{children:r.jsxs("label",{className:"flex items-center gap-3",children:[r.jsx("input",{type:"checkbox",name:"show_in_graph",checked:_.show_in_graph,onChange:B,className:"rounded border-gray-300 text-primary-600 focus:ring-primary-500"}),r.jsxs("div",{children:[r.jsx("span",{className:"dark:text-white font-medium",children:"Show in Live Graph"}),r.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"When enabled, traffic matching this port will appear as a colored bar in the subscriber live bandwidth graph"})]})]})}),_.show_in_graph&&r.jsxs("div",{children:[r.jsx("label",{className:"label",children:"Graph Color"}),r.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[b.map(e=>r.jsx("button",{type:"button",onClick:()=>w(s=>({...s,color:e})),className:m("w-7 h-7 rounded-full border-2 transition-transform",_.color===e?"border-gray-800 dark:border-white scale-110":"border-transparent hover:scale-105"),style:{backgroundColor:e},title:e},e)),r.jsx("input",{type:"color",value:_.color,onChange:e=>w(s=>({...s,color:e.target.value})),className:"w-7 h-7 rounded cursor-pointer border border-gray-300 dark:border-gray-600",title:"Custom color"}),r.jsx("span",{className:"text-xs text-gray-500 font-mono",children:_.color})]})]})]}),_.name&&("dscp"===_.direction||_.port)&&r.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-3 font-mono text-xs text-gray-600 dark:text-gray-300 space-y-1",children:[r.jsx("div",{className:"text-gray-400 mb-1",children:"MikroTik preview:"}),r.jsxs("div",{children:["queue type: PORT-",_.name,"-",_.speed_mbps," (",_.speed_mbps,"M PCQ)"]}),"dscp"===_.direction?r.jsxs("div",{children:["mangle: chain=postrouting dscp=",_.dscp_value," new-packet-mark=PORT-",_.name," passthrough=no"]}):r.jsxs(r.Fragment,{children:[("src"===_.direction||"both"===_.direction)&&r.jsxs("div",{children:["mangle: chain=forward protocol=tcp src-port=",_.port," mark=PORT-",_.name]}),("dst"===_.direction||"both"===_.direction)&&r.jsxs("div",{children:["mangle: chain=forward protocol=tcp dst-port=",_.port," mark=PORT-",_.name]})]}),r.jsxs("div",{children:["queue: PORT-",_.name,"-",_.speed_mbps,"M (packet-mark=PORT-",_.name,")"]})]}),r.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t dark:border-gray-700",children:[r.jsx("button",{type:"button",onClick:D,className:"btn-secondary",children:"Cancel"}),r.jsx("button",{type:"submit",disabled:F.isPending,className:"btn-primary",children:F.isPending?"Saving...":k?"Update":"Create"})]})]})]})]})})]})}export{v as default};
