import{b as e,u as a,d as t,j as r}from"./data-vendor-DrqtOFCb.js";import{r as s}from"./react-vendor-_qYBQpt5.js";import{Q as l}from"./index-BAxY-e20.js";import"./ui-vendor-C17HITwC.js";import"./chart-vendor-CsTzT1mg.js";function d(){const d=e(),[n,i]=s.useState(!1),[c,x]=s.useState(null),[o,u]=s.useState({name:"",trigger_event:"expiry_warning",channel:"sms",days_before:3,template:"",enabled:!0,send_to_reseller:!1,fup_levels:["1","2","3"]}),{data:g,isLoading:m}=a({queryKey:["communication-rules"],queryFn:()=>l.get("/communication/rules").then(e=>e.data.data||[])}),{data:y}=a({queryKey:["communication-templates"],queryFn:()=>l.get("/communication/templates").then(e=>e.data.data||[])}),h=t({mutationFn:e=>l.post("/communication/rules",e),onSuccess:()=>{d.invalidateQueries(["communication-rules"]),k()}}),b=t({mutationFn:({id:e,...a})=>l.put(`/communication/rules/${e}`,a),onSuccess:()=>{d.invalidateQueries(["communication-rules"]),k()}}),p=t({mutationFn:e=>l.delete(`/communication/rules/${e}`),onSuccess:()=>d.invalidateQueries(["communication-rules"])}),f=t({mutationFn:({id:e,enabled:a})=>l.put(`/communication/rules/${e}`,{enabled:a}),onSuccess:()=>d.invalidateQueries(["communication-rules"])}),v=[{value:"expiry_warning",label:"Expiry Warning",description:"Send X days before expiry"},{value:"expired",label:"Account Expired",description:"When subscription expires"},{value:"quota_warning",label:"Quota Warning",description:"When quota reaches threshold"},{value:"quota_exceeded",label:"Quota Exceeded",description:"When quota is fully used"},{value:"payment_received",label:"Payment Received",description:"After successful payment"},{value:"account_created",label:"Account Created",description:"When new account is created"},{value:"account_renewed",label:"Account Renewed",description:"When subscription is renewed"},{value:"password_changed",label:"Password Changed",description:"When password is updated"},{value:"session_started",label:"Session Started",description:"When user connects"},{value:"fup_applied",label:"FUP Applied",description:"When FUP limit is reached"}],k=()=>{i(!1),x(null),u({name:"",trigger_event:"expiry_warning",channel:"sms",days_before:3,template:"",enabled:!0,send_to_reseller:!1,fup_levels:["1","2","3"]})},j=e=>{const a=v.find(a=>a.value===e);return a?a.label:e};return m?r.jsx("div",{className:"flex items-center justify-center h-64",children:r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"text-2xl font-semibold text-gray-900 dark:text-white",children:"Communication Rules"}),r.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 dark:text-gray-500 mt-1",children:"Configure automated SMS, Email, and WhatsApp notifications"})]}),r.jsx("button",{onClick:()=>i(!0),className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"Add Rule"})]}),r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[r.jsxs("div",{className:"bg-white dark:bg-gray-800 p-4 rounded-lg shadow",children:[r.jsx("div",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:(g||[]).length}),r.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 dark:text-gray-500 dark:text-gray-400",children:"Total Rules"})]}),r.jsxs("div",{className:"bg-white dark:bg-gray-800 p-4 rounded-lg shadow",children:[r.jsx("div",{className:"text-2xl font-bold text-green-600",children:(g||[]).filter(e=>e.enabled).length}),r.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 dark:text-gray-500 dark:text-gray-400",children:"Active Rules"})]}),r.jsxs("div",{className:"bg-white dark:bg-gray-800 p-4 rounded-lg shadow",children:[r.jsx("div",{className:"text-2xl font-bold text-blue-600",children:(g||[]).filter(e=>"sms"===e.channel).length}),r.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 dark:text-gray-500 dark:text-gray-400",children:"SMS Rules"})]}),r.jsxs("div",{className:"bg-white dark:bg-gray-800 p-4 rounded-lg shadow",children:[r.jsx("div",{className:"text-2xl font-bold text-purple-600",children:(g||[]).filter(e=>"email"===e.channel).length}),r.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 dark:text-gray-500 dark:text-gray-400",children:"Email Rules"})]})]}),r.jsxs("div",{className:"bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden",children:[r.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[r.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700",children:r.jsxs("tr",{children:[r.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase",children:"Name"}),r.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase",children:"Trigger"}),r.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase",children:"Channel"}),r.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase",children:"Days Before"}),r.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase",children:"Status"}),r.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase",children:"Actions"})]})}),r.jsx("tbody",{className:"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700",children:(g||[]).map(e=>{return r.jsxs("tr",{className:"hover:bg-gray-50 dark:bg-gray-700",children:[r.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[r.jsx("div",{className:"text-sm font-medium text-gray-900 dark:text-white",children:e.name}),e.send_to_reseller&&r.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 dark:text-gray-500 dark:text-gray-400",children:"+ Send to Reseller"})]}),r.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[r.jsx("div",{className:"text-sm text-gray-900 dark:text-white",children:j(e.trigger_event)}),"fup_applied"===e.trigger_event&&e.fup_levels&&r.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-0.5",children:["Levels: ",e.fup_levels.split(",").map(e=>`FUP ${e}`).join(", ")]})]}),r.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:r.jsx("span",{className:`px-2 py-1 text-xs rounded-full capitalize ${a=e.channel,{sms:"bg-green-100 text-green-800",email:"bg-blue-100 text-blue-800",whatsapp:"bg-emerald-100 text-emerald-800"}[a]||"bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200"}`,children:e.channel})}),r.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 dark:text-gray-500 dark:text-gray-400",children:"quota_warning"===e.trigger_event?e.days_before>0?`${e.days_before}%`:"-":e.days_before>0?`${e.days_before} days`:"-"}),r.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:r.jsx("button",{onClick:()=>f.mutate({id:e.id,enabled:!e.enabled}),className:"relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 "+(e.enabled?"bg-blue-600":"bg-gray-200"),children:r.jsx("span",{className:"pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white dark:bg-gray-800 shadow transition duration-200 "+(e.enabled?"translate-x-5":"translate-x-0")})})}),r.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:[r.jsx("button",{onClick:()=>(e=>{x(e),u({name:e.name,trigger_event:e.trigger_event,channel:e.channel,days_before:e.days_before||0,template:e.template,enabled:e.enabled,send_to_reseller:e.send_to_reseller||!1,fup_levels:e.fup_levels?e.fup_levels.split(","):["1","2","3"]}),i(!0)})(e),className:"text-blue-600 hover:text-blue-900 mr-3",children:"Edit"}),r.jsx("button",{onClick:()=>{confirm("Delete this rule?")&&p.mutate(e.id)},className:"text-red-600 hover:text-red-900",children:"Delete"})]})]},e.id);var a})})]}),0===(g||[]).length&&r.jsx("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400 dark:text-gray-500 dark:text-gray-400",children:'No communication rules configured. Click "Add Rule" to create one.'})]}),n&&r.jsx("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:r.jsxs("div",{className:"flex min-h-screen items-center justify-center p-4",children:[r.jsx("div",{className:"fixed inset-0 bg-gray-500 bg-opacity-75",onClick:k}),r.jsxs("div",{className:"relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-lg w-full p-6",children:[r.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-4",children:c?"Edit Rule":"Add Communication Rule"}),r.jsxs("form",{onSubmit:e=>{e.preventDefault();const a={...o,fup_levels:Array.isArray(o.fup_levels)?o.fup_levels.join(","):o.fup_levels};c?b.mutate({id:c.id,...a}):h.mutate(a)},className:"space-y-4",children:[r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 dark:text-gray-500 dark:text-gray-400",children:"Rule Name"}),r.jsx("input",{type:"text",value:o.name,onChange:e=>u({...o,name:e.target.value}),className:"mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:focus:ring-blue-400",required:!0})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 dark:text-gray-500 dark:text-gray-400",children:"Trigger Event"}),r.jsx("select",{value:o.trigger_event,onChange:e=>{const a=e.target.value,t={trigger_event:a};"quota_warning"===a?t.days_before=80:"expiry_warning"===a&&(t.days_before=3),u({...o,...t})},className:"mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:focus:ring-blue-400",children:v.map(e=>r.jsxs("option",{value:e.value,children:[e.label," - ",e.description]},e.value))})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 dark:text-gray-500 dark:text-gray-400",children:"Channel"}),r.jsx("select",{value:o.channel,onChange:e=>u({...o,channel:e.target.value}),className:"mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:focus:ring-blue-400",children:[{value:"sms",label:"SMS"},{value:"email",label:"Email"},{value:"whatsapp",label:"WhatsApp"}].map(e=>r.jsx("option",{value:e.value,children:e.label},e.value))})]}),"expiry_warning"===o.trigger_event&&r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 dark:text-gray-500 dark:text-gray-400",children:"Days Before Expiry"}),r.jsx("input",{type:"number",min:"1",max:"30",value:o.days_before,onChange:e=>u({...o,days_before:parseInt(e.target.value)}),className:"mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:focus:ring-blue-400"}),r.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"Send notification this many days before expiry"})]}),"quota_warning"===o.trigger_event&&r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 dark:text-gray-500 dark:text-gray-400",children:"Quota Threshold (%)"}),r.jsx("input",{type:"number",min:"1",max:"99",value:o.days_before,onChange:e=>u({...o,days_before:parseInt(e.target.value)}),className:"mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:focus:ring-blue-400"}),r.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"Send when monthly quota usage reaches this % (e.g. 80 = notify at 80% used)"})]}),"fup_applied"===o.trigger_event&&r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Trigger on FUP Level"}),r.jsx("div",{className:"mt-2 flex space-x-6",children:[{value:"1",label:"FUP 1"},{value:"2",label:"FUP 2"},{value:"3",label:"FUP 3"}].map(({value:e,label:a})=>r.jsxs("label",{className:"flex items-center cursor-pointer",children:[r.jsx("input",{type:"checkbox",checked:o.fup_levels.includes(e),onChange:a=>{const t=a.target.checked?[...o.fup_levels,e].sort():o.fup_levels.filter(a=>a!==e);u({...o,fup_levels:t})},className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:focus:ring-blue-400"}),r.jsx("span",{className:"ml-2 text-sm font-medium text-gray-700 dark:text-gray-300",children:a})]},e))}),r.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"Select which FUP levels trigger this rule. You can create separate rules for each level."})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 dark:text-gray-500 dark:text-gray-400",children:"Message Template"}),r.jsx("textarea",{value:o.template,onChange:e=>u({...o,template:e.target.value}),rows:4,className:"mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:focus:ring-blue-400",placeholder:"Use variables: {username}, {full_name}, {expiry_date}, {service_name}, {balance}"}),r.jsxs("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400 dark:text-gray-500 dark:text-gray-400",children:["Available variables: ","{username}",", ","{full_name}",", ","{service_name}",", ","{balance}",["expiry_warning","expired"].includes(o.trigger_event)&&r.jsxs(r.Fragment,{children:[", ","{expiry_date}",", ",r.jsx("strong",{children:"{days_before}"})," (days until expiry)"]}),"fup_applied"===o.trigger_event&&r.jsxs(r.Fragment,{children:[", ","{quota_used}",", ","{quota_total}",", ",r.jsx("strong",{children:"{fup_level}"})," (1, 2, or 3)"]}),"quota_warning"===o.trigger_event&&r.jsxs(r.Fragment,{children:[", ",r.jsx("strong",{children:"{quota_used}"})," (GB used), ",r.jsx("strong",{children:"{quota_total}"})," (GB total), ",r.jsx("strong",{children:"{quota_percent}"})," (% used)"]})]})]}),r.jsxs("div",{className:"flex items-center space-x-6",children:[r.jsxs("label",{className:"flex items-center",children:[r.jsx("input",{type:"checkbox",checked:o.enabled,onChange:e=>u({...o,enabled:e.target.checked}),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:focus:ring-blue-400"}),r.jsx("span",{className:"ml-2 text-sm text-gray-700 dark:text-gray-300 dark:text-gray-500 dark:text-gray-400",children:"Enabled"})]}),r.jsxs("label",{className:"flex items-center",children:[r.jsx("input",{type:"checkbox",checked:o.send_to_reseller,onChange:e=>u({...o,send_to_reseller:e.target.checked}),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:focus:ring-blue-400"}),r.jsx("span",{className:"ml-2 text-sm text-gray-700 dark:text-gray-300 dark:text-gray-500 dark:text-gray-400",children:"Also notify Reseller"})]})]}),r.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[r.jsx("button",{type:"button",onClick:k,className:"px-4 py-2 text-sm text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-gray-600 rounded-md hover:bg-gray-200 dark:bg-gray-600",children:"Cancel"}),r.jsxs("button",{type:"submit",disabled:h.isPending||b.isPending,className:"px-4 py-2 text-sm text-white bg-blue-600 rounded-md hover:bg-blue-700",children:[c?"Update":"Create"," Rule"]})]})]})]})]})})]})}export{d as default};
